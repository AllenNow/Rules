# 咖啡iOS app安全测试漏洞修复文档

## 目录
* 一、二进制程序保护
* 二、程序完整性校验
* 三、符号表信息泄露
* 四、程序数据存储安全
* 五、动态调试防护
* 六、HTTPS 证书校验
* 七、输入检测


## 一、二进制程序保护

#### 1、采用的方案：
对敏感的类名和方法名进行代码混淆

#### 2、已涉及到的范围：
* ①、支付敏感信息

>
```
LuckyPayService类及其下的方法
LuckyUnitePay类及其下的方法
```

* ②、登录的敏感信息

>
```
LuckyLoginModel类及其下的方法
```

* ③、用于混淆'所混淆的类'是重要类的'原本不需要混淆的类'

>
```
LuckyGiveCoffeeModel
UserInfo
```

#### 3、不去修复的地方：

`UPPaymentControl`虽是支付部分，但其是属第三方静态库`libPaymentControl.a`，若只混淆暴露出来的`.h`文件中的类和方法名，而不去改变编译后的`.a`文件，容易出问题，所以不去处理。


## 二、程序完整性校验

用户安装包来自 App Store，资源文件缺失或者被篡改的可能性极低。暂时不处理。


## 三、符号表信息泄露
不进行修复。

原因：删除符号表会导致审核无法通过。
## 四、程序数据存储安全
#### 1、改动：
* ①、敏感文件信息存储位置；存储到自定义路径的json文件中（document目录下，default.json文件中）；
* ②、对敏感信息进行对称加密，加密方案为AES+BASE64加密
* ③、加密的密钥采用图片隐写的方案保存在工程的特定图片中

#### 2、未改动：
* ①、非敏感信息存储位置
* ②、非敏感信息加密



## 五、动态调试防护

已用 arm 指令和 ptrace 防止动态调试

## 六、HTTPS 证书校验

因为SNI问题导致ip访问服务器无法获取正确的证书，导致校验失败，故线上的版本关闭了合法证书的校验。
目前通过修改NSURLProtocol+hook 的方式，对NSURLRequest 使用CFNetworking进行重新构造，放入host头，并进行证书校验。

## 七、输入检测

暂未修复，后续改。
